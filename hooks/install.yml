---
- name: create Atomic Host image
  os_image:
    name: atomic_host_image
    container_format: bare
    disk_format: qcow2
    state: present
    filename: '{{ atomic_host_path }}'

- name: stat centos id_rsa file
  stat:
    path: /home/centos/.ssh/id_rsa
  register: centos_id_rsa

- name: generate SSH keys for centos
  shell: ssh-keygen -b 2048 -t rsa -f /home/centos/.ssh/id_rsa -q -N ""
  when: centos_id_rsa.stat.exists == False

- name: delete atomic ssh key in OSP
  os_keypair:
    auth:
      auth_url: "{{ lookup('env', 'OS_AUTH_URL') }}"
      username: "{{ lookup('env', 'OS_USERNAME') }}"
      password: "{{ lookup('env', 'OS_PASSWORD') }}"
      user_domain_name:  "{{ lookup('env', 'OS_USER_DOMAIN_NAME') }}"
      project_domain_name:  "{{ lookup('env', 'OS_PROJECT_DOMAIN_NAME') }}"
      project_name: "{{ lookup('env', 'OS_PROJECT_NAME') }}"
    state: absent
    name: centos

- name: create key in OSP for centos
  os_keypair:
    auth:
      auth_url: "{{ lookup('env', 'OS_AUTH_URL') }}"
      username: "{{ lookup('env', 'OS_USERNAME') }}"
      password: "{{ lookup('env', 'OS_PASSWORD') }}"
      user_domain_name:  "{{ lookup('env', 'OS_USER_DOMAIN_NAME') }}"
      project_domain_name:  "{{ lookup('env', 'OS_PROJECT_DOMAIN_NAME') }}"
      project_name: "{{ lookup('env', 'OS_PROJECT_NAME') }}"
    state: present
    name: centos
    public_key_file: /home/centos/.ssh/id_rsa.pub

- name: create Atomic Host instance
  os_server:
    state: present
    name: atomic_host_instance
    image: atomic_host_image
    key_name: centos
    timeout: 200
    flavor: m1.small
    floating_ips:
      - '{{ hostvars.atomic.ansible_ssh_host }}'
    volume_size: 30
    security_groups: ['ssh']
    network: local

- name: Set atomic VM variables
  set_fact:
    atomic_ssh_host: "{{ hostvars.atomic.ansible_ssh_host }}"
    atomic_ssh_port: "22"
    atomic_ssh_user: "fedora"
    atomic_ssh_private_key_file: "/home/centos/.ssh/id_rsa"
---
- name: delete atomic-host-tests folder
  file:
    state: absent
    path: '/tmp/atomic-host-tests'

- name: download atomic-host-tests
  git:
    repo: "{{ test['repository'] }}"
    dest: '/tmp/atomic-host-tests'
    version: "{{ test['version'] }}"

- name: copy ansible.cfg
  copy:
    src: ansible.cfg
    dest: /tmp/atomic-host-tests/ansible.cfg

- name: get RHSM variables
  set_fact:
    RHSM_USERNAME: "{{ lookup('env', 'RHSM_USERNAME') }}"
    RHSM_PASSWORD: "{{ lookup('env', 'RHSM_PASSWORD') }}"
    RHSM_ACTIVATION_KEY: "{{ lookup('env', 'RHSM_ACTIVATION_KEY') }}"
    RHSM_ORG_ID: "{{ lookup('env', 'RHSM_ORG_ID') }}"

- name: create RHSM file
  template:
    src: subscription_data.csv.j2
    dest: /tmp/atomic-host-tests/roles/redhat_subscription/files/subscription_data.csv
  when: RHSM_USERNAME != '' or RHSM_ACTIVATION_KEY!= ''

- name: run tests
  shell: "ansible-playbook --user='{{ SSH_USER }}' --private-key='{{ SSH_PRIVATE_KEY_FILE }}' --inventory-file='{{ SSH_HOST }}:{{ SSH_PORT | default(22) }},' tests/{{ item }}/main.yml"
  args:
    chdir: /tmp/atomic-host-tests
  environment:
    JUNIT_OUTPUT_DIR: '/tmp/{{ job_id }}'
  with_items:
#    - admin-unlock
#    - docker
#    - docker-build-httpd
#    - docker-swarm
#    - images_cve_scanner
    - improved-sanity-test
#    - k8-cluster
#    - openshift-ansible-test
#    - pkg-layering
#    - rpm-ostree
#    - system-containers
#    - unique-machine-id
  ignore_errors: True

- name: combine JUnit results into single file
  shell: "xunitmerge /tmp/{{ job_id }}/*.xml /tmp/{{ job_id }}/junit.xml"

- name: upload the results
  dci_file:
    job_id: '{{ job_id }}'
    path: "/tmp/{{ job_id }}/junit.xml"
    mime: 'application/junit'
    name: 'Atomic Host tests'